# üîç Sistema de Diagn√≥stico - Asistente SIMAP

Este sistema proporciona herramientas completas para diagnosticar y monitorear el estado de la aplicaci√≥n del Asistente SIMAP. Incluye tanto endpoints web como scripts independientes para verificar todos los componentes del sistema.

## üìã ¬øQu√© verifica el sistema?

### ‚úÖ Componentes verificados:

1. **üñ•Ô∏è Entorno de Ejecuci√≥n**
   - Detecta si est√° corriendo en Windows, Linux o Docker
   - Verifica entorno virtual activo en Windows
   - Valida que est√© usando el entorno virtual "tot17" recomendado
   - Proporciona recomendaciones espec√≠ficas por entorno

2. **üöÄ Uvicorn (Servidor Web)**
   - Verifica que el servidor est√© ejecut√°ndose
   - Obtiene informaci√≥n de versi√≥n y proceso

3. **üîç Qdrant (Base de Datos Vectorial)**
   - Conexi√≥n con el servidor Qdrant
   - Existencia de colecciones
   - Funcionalidad de consultas de similitud
   - Tiempo de respuesta

4. **üóÑÔ∏è Base de Datos Relacional (MySQL/SQLite Dual)**
   - **L√≥gica de fallback autom√°tico**: Intenta MySQL primero, si falla usa SQLite
   - Reporta el estado de ambas bases de datos
   - Indica claramente cu√°l est√° activa y por qu√©
   - Conexi√≥n con MySQL o SQLite (seg√∫n configuraci√≥n y disponibilidad)
   - Verificaci√≥n de tablas del sistema
   - Conteo de registros en cada tabla
   - Integridad de la estructura

5. **ü§ñ OpenAI**
   - Validaci√≥n de API Key
   - Funcionamiento de embeddings
   - Funcionamiento del modelo de chat (LLM)
   - Tiempos de respuesta

6. **üìÅ Archivos Cr√≠ticos**
   - Existencia de scripts principales
   - Archivos de configuraci√≥n
   - Tama√±os y fechas de modificaci√≥n

7. **‚öôÔ∏è Variables de Entorno**
   - Configuraci√≥n de todas las variables necesarias
   - Validaci√≥n de archivos .env y config.ini

## üñ•Ô∏è Entornos de Ejecuci√≥n Soportados

### 1. **Windows + Virtual Environment "tot17" (Recomendado)**
- **Estado**: ‚úÖ OK
- **Descripci√≥n**: Configuraci√≥n ideal para desarrollo
- **Activaci√≥n**: `.\\tot17\\Scripts\\activate`
- **Verificaci√≥n**: El sistema detecta autom√°ticamente si est√° activo

### 2. **Windows + Otro Virtual Environment**
- **Estado**: ‚ö†Ô∏è WARNING
- **Descripci√≥n**: Funcional pero no es el entorno recomendado
- **Recomendaci√≥n**: Cambiar al entorno "tot17"

### 3. **Windows sin Virtual Environment**
- **Estado**: ‚ö†Ô∏è WARNING  
- **Descripci√≥n**: Riesgo de conflictos de dependencias
- **Recomendaci√≥n**: Activar entorno virtual "tot17"

### 4. **Docker Container**
- **Estado**: ‚úÖ OK
- **Descripci√≥n**: Configuraci√≥n ideal para producci√≥n
- **Detecci√≥n**: Autom√°tica mediante indicadores del contenedor

### 5. **Linux**
- **Estado**: ‚úÖ OK
- **Descripci√≥n**: Entorno de servidor est√°ndar

## üóÑÔ∏è Sistema de Base de Datos Dual

### L√≥gica de Fallback Autom√°tico:

1. **Primer intento: MySQL**
   - Si MySQL est√° disponible y conecta ‚Üí **Estado: OK**
   - Configuraci√≥n √≥ptima para producci√≥n

2. **Fallback: SQLite**
   - Si MySQL falla ‚Üí Intenta autom√°ticamente con SQLite
   - Si SQLite conecta ‚Üí **Estado: WARNING** (MySQL desactivado)
   - Informa claramente que est√° usando fallback

3. **Ambos fallan**
   - **Estado: ERROR**
   - No hay conexi√≥n disponible a base de datos

### Interpretaci√≥n de estados:

| Estado | Base Activa | Significado |
|--------|-------------|-------------|
| **‚úÖ OK** | MySQL | Configuraci√≥n √≥ptima, MySQL funcionando |
| **‚ö†Ô∏è WARNING** | SQLite | MySQL desactivado/no disponible, usando SQLite como respaldo |
| **‚ùå ERROR** | Ninguna | No se pudo conectar a ninguna base de datos |

## üåê Uso desde el Navegador Web

### Prerrequisitos
- La aplicaci√≥n FastAPI debe estar ejecut√°ndose
- Uvicorn debe estar activo en el puerto configurado (normalmente 8000)

### Endpoints disponibles:

#### 1. **Diagn√≥stico Completo HTML**
```
http://localhost:8000/api/health
```
- Interfaz visual completa con Bootstrap
- Muestra estado de todos los componentes incluido el entorno de ejecuci√≥n
- Informaci√≥n destacada sobre base de datos dual
- Actualizaci√≥n autom√°tica en caso de errores
- C√≥digo de colores para f√°cil identificaci√≥n

#### 2. **Diagn√≥stico JSON**
```
http://localhost:8000/api/health/json
```
- Datos estructurados en formato JSON
- Incluye informaci√≥n detallada del entorno de ejecuci√≥n
- Detalles de estado de MySQL y SQLite
- √ötil para integraci√≥n con sistemas de monitoreo

#### 3. **Estado B√°sico**
```
http://localhost:8000/api/status
```
- Verificaci√≥n r√°pida de componentes cr√≠ticos
- Respuesta ligera para checks de salud

### Ejemplo de uso:
1. Abrir navegador
2. Ir a `http://localhost:8000/api/health`
3. Revisar el reporte visual completo
4. Observar el estado del entorno de ejecuci√≥n en la secci√≥n destacada
5. Verificar qu√© base de datos est√° activa (MySQL/SQLite)

## üíª Uso desde L√≠nea de Comandos (CMD)

### Script Independiente: `diagnostico_sistema.py`

Este script puede ejecutarse **sin necesidad de que FastAPI est√© ejecut√°ndose**, lo que lo hace ideal para:
- Verificaciones antes de iniciar la aplicaci√≥n
- Diagn√≥sticos cuando la aplicaci√≥n no responde
- Verificaci√≥n del entorno virtual en Windows
- Automatizaci√≥n de verificaciones
- Integraci√≥n en scripts de deployment

### Comandos disponibles:

#### 1. **Diagn√≥stico B√°sico**
```cmd
python diagnostico_sistema.py
```
- Ejecuta todas las verificaciones incluido entorno y base de datos dual
- Muestra resultado en consola con colores
- Salida legible para humanos

#### 2. **Diagn√≥stico Detallado**
```cmd
python diagnostico_sistema.py --verbose
```
- Incluye informaci√≥n t√©cnica detallada
- Muestra configuraciones espec√≠ficas del entorno
- Detalles de las pruebas de conexi√≥n MySQL/SQLite
- √ötil para debugging

#### 3. **Salida en JSON**
```cmd
python diagnostico_sistema.py --json
```
- Genera output en formato JSON
- Incluye toda la informaci√≥n del entorno de ejecuci√≥n
- Estado detallado de ambas bases de datos
- √ötil para procesamiento automatizado

#### 4. **Guardar Resultado en Archivo**
```cmd
python diagnostico_sistema.py --json --output diagnostico_resultado.json
```
- Guarda el resultado en un archivo
- √ötil para auditor√≠as o reportes

#### 5. **Ayuda**
```cmd
python diagnostico_sistema.py --help
```
- Muestra todas las opciones disponibles
- Ejemplos de uso

### Ejemplos pr√°cticos:

#### Verificaci√≥n de entorno antes de iniciar:
```cmd
# Verificar que el entorno virtual "tot17" est√© activo
python diagnostico_sistema.py --verbose

# Verificar c√≥digo de salida
if %errorlevel% neq 0 (
    echo "Sistema no est√° listo para desarrollo"
    echo "Activar entorno virtual: .\tot17\Scripts\activate"
    exit /b 1
)

# Si todo est√° OK, iniciar la aplicaci√≥n
python app/main.py
```

#### Verificaci√≥n de base de datos:
```cmd
# Verificar estado de MySQL/SQLite
python diagnostico_sistema.py --json | findstr "database_dual_connection"
```

#### Verificaci√≥n en Docker:
```cmd
# Dentro del contenedor Docker
python diagnostico_sistema.py --verbose
# Deber√≠a detectar autom√°ticamente que est√° en Docker
```

## üé® Interpretaci√≥n de Resultados

### Estados posibles:

| Estado | Icono | Color | Descripci√≥n |
|--------|-------|-------|-------------|
| **OK** | ‚úÖ | Verde | Componente funcionando correctamente |
| **WARNING** | ‚ö†Ô∏è | Amarillo | Componente funcional pero con advertencias |
| **ERROR** | ‚ùå | Rojo | Componente con problemas cr√≠ticos |

### C√≥digos de salida (CMD):
- **0**: Todo OK
- **1**: Advertencias (sistema funcional)
- **2**: Errores cr√≠ticos
- **130**: Interrumpido por usuario (Ctrl+C)

### Estados espec√≠ficos del entorno:

#### Entorno de Ejecuci√≥n:
- **Windows + tot17** = ‚úÖ OK (Recomendado para desarrollo)
- **Windows + otro venv** = ‚ö†Ô∏è WARNING 
- **Windows sin venv** = ‚ö†Ô∏è WARNING
- **Docker** = ‚úÖ OK (Recomendado para producci√≥n)
- **Linux** = ‚úÖ OK

#### Base de Datos Dual:
- **MySQL activo** = ‚úÖ OK
- **SQLite activo (MySQL desactivado)** = ‚ö†Ô∏è WARNING
- **Ninguna base disponible** = ‚ùå ERROR

## üõ†Ô∏è Soluci√≥n de Problemas Comunes

### Error: "Windows SIN entorno virtual activo"
**Causa**: No hay entorno virtual activado en Windows
**Soluci√≥n**: 
```cmd
# Activar entorno virtual tot17
cd /ruta/a/tu/proyecto
.\tot17\Scripts\activate
python diagnostico_sistema.py
```

### Warning: "Conectado a SQLite (MySQL desactivado)"
**Causa**: MySQL no est√° disponible, usando SQLite como fallback
**Soluci√≥n**:
```cmd
# Verificar si MySQL est√° instalado y ejecut√°ndose
# En Windows (XAMPP/WAMP):
net start mysql

# En Docker:
docker run --name mysql -e MYSQL_ROOT_PASSWORD=password -d mysql:8.0

# Verificar configuraci√≥n en config.ini:
# BD_SERVER=localhost
# BD_PORT=3306
# BD_USER=root
# BD_PASSWD=tu_password
```

### Error: "Uvicorn no responde"
**Causa**: La aplicaci√≥n FastAPI no est√° ejecut√°ndose
**Soluci√≥n**: 
```cmd
# Asegurarse de que el entorno virtual est√© activo
.\tot17\Scripts\activate

# Iniciar la aplicaci√≥n
cd /ruta/a/tu/proyecto
python app/main.py
```

### Error: "Qdrant no conecta"
**Causa**: Servidor Qdrant no est√° activo
**Soluci√≥n**:
```cmd
# En Windows, verificar si Qdrant est√° ejecut√°ndose
netstat -an | findstr :6333

# En Docker:
docker run -p 6333:6333 qdrant/qdrant

# Verificar configuraci√≥n en config.ini o .env:
# QDRANT_URL=http://localhost:6333
```

### Error: "OpenAI API Key"
**Causa**: API Key no configurada o inv√°lida
**Soluci√≥n**:
1. Verificar que OPENAI_API_KEY est√© en config.ini o .env
2. Validar que la key sea correcta y tenga cr√©ditos
3. Verificar conexi√≥n a internet

### Error: "Archivos cr√≠ticos faltantes"
**Causa**: Estructura del proyecto incompleta
**Soluci√≥n**:
```cmd
# Verificar que est√°s en el directorio correcto del proyecto
# Restaurar archivos desde git o backup
git status
git checkout -- archivo_faltante.py
```

## üìä Ejemplo de Reporte

### Diagn√≥stico CMD con entorno Windows + tot17:
```
üîç DIAGN√ìSTICO DEL SISTEMA - ASISTENTE SIMAP
============================================================

üñ•Ô∏è Entorno de Ejecuci√≥n:
‚úÖ Ejecut√°ndose en Windows con entorno virtual 'tot17' activo

üêç Python y Entorno:
‚úÖ Entorno Python configurado correctamente

‚öôÔ∏è Variables de Entorno:
‚úÖ Variables de entorno verificadas: 5/5 configuradas

üìÅ Archivos Cr√≠ticos:
‚úÖ Archivos cr√≠ticos verificados: 7/7 encontrados

üîç Qdrant (Base Vectorial):
‚úÖ Qdrant conectado correctamente

üóÑÔ∏è Base de Datos (MySQL/SQLite):
‚ö†Ô∏è Conectado a SQLite (MySQL desactivado/no disponible - fallback activo)

ü§ñ OpenAI:
‚úÖ OpenAI conectado y funcionando

============================================================
üìã RESUMEN DEL DIAGN√ìSTICO
============================================================
‚ö†Ô∏è Estado General del Sistema: WARNING
‚úÖ Verificaciones exitosas: 5
‚ö†Ô∏è Advertencias: 2
‚ùå Errores: 0
‚è±Ô∏è Tiempo de ejecuci√≥n: 3.45 segundos

üñ•Ô∏è ENTORNO: Windows + Virtual Environment (tot17) ‚úÖ

‚ö†Ô∏è ADVERTENCIAS:
  ‚Ä¢ Entorno de Ejecuci√≥n: Ejecut√°ndose en Windows con entorno virtual 'tot17' activo
  ‚Ä¢ Base de Datos (MySQL/SQLite): Conectado a SQLite (MySQL desactivado/no disponible - fallback activo)

‚ö†Ô∏è Sistema funcionando con advertencias
```

### Diagn√≥stico en Docker:
```
üîç DIAGN√ìSTICO DEL SISTEMA - ASISTENTE SIMAP
============================================================

üñ•Ô∏è Entorno de Ejecuci√≥n:
‚úÖ Ejecut√°ndose en contenedor Docker

üóÑÔ∏è Base de Datos (MySQL/SQLite):
‚úÖ Conectado a MySQL (base de datos principal)

üê≥ ENTORNO: Docker Container

üéâ ¬°Sistema funcionando correctamente!
```

## üîÑ Automatizaci√≥n y Monitoreo

### Script para verificaci√≥n de entorno en Windows:
```cmd
@echo off
echo Verificando entorno de desarrollo...

# Verificar que tot17 est√© activo
python diagnostico_sistema.py --json > temp_diag.json
findstr "tot17" temp_diag.json >nul
if errorlevel 1 (
    echo ‚ö†Ô∏è ADVERTENCIA: Entorno virtual tot17 no est√° activo
    echo Ejecutar: .\tot17\Scripts\activate
    pause
)

echo ‚úÖ Entorno verificado
del temp_diag.json
```

### Monitoreo de base de datos dual:
```cmd
@echo off
python diagnostico_sistema.py --json | findstr "active_connection" > db_status.txt
set /p db_status=<db_status.txt

if "%db_status%"=="MySQL" (
    echo ‚úÖ Usando MySQL - Configuraci√≥n √≥ptima
) else if "%db_status%"=="SQLite" (
    echo ‚ö†Ô∏è Usando SQLite - MySQL no disponible
    echo Considerar activar MySQL para mejor rendimiento
) else (
    echo ‚ùå No hay conexi√≥n a base de datos
)
```

### Integraci√≥n con Task Scheduler (Windows):
1. Abrir Task Scheduler
2. Crear nueva tarea: "Diagn√≥stico SIMAP"
3. Configurar trigger (ej: cada hora)
4. Acci√≥n: ejecutar `python diagnostico_sistema.py --json --output C:\logs\diagnostico_%date%.json`
5. Configurar alertas basadas en c√≥digos de salida

## üìû Soporte

Si encuentras problemas con el sistema de diagn√≥stico:

1. **Ejecuta diagn√≥stico detallado**: `python diagnostico_sistema.py --verbose`
2. **Verifica el entorno de ejecuci√≥n**: Confirma que est√©s en el entorno correcto (tot17 en Windows)
3. **Revisa la configuraci√≥n de base de datos**: Verifica config.ini para MySQL/SQLite
4. **Revisa logs de la aplicaci√≥n**: Archivos .log en el directorio del proyecto
5. **Consulta documentaci√≥n**: README principal del proyecto

### Problemas espec√≠ficos por entorno:

#### Windows:
- Verificar que el entorno virtual "tot17" est√© activo
- Comprobar que MySQL est√© instalado (XAMPP/WAMP) si se requiere
- Verificar permisos de escritura en directorios del proyecto

#### Docker:
- Verificar que los vol√∫menes est√©n montados correctamente
- Comprobar conectividad de red entre contenedores
- Revisar que requirements.txt est√© actualizado

---

**Autor**: Sistema SIMAP  
**√öltima actualizaci√≥n**: 2025  
**Versi√≥n**: 2.0 - Entorno Dual y Detecci√≥n Autom√°tica 