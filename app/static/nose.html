<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas del Asistente</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .filters { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;}
        .filters label { margin-right: 10px; font-weight: bold;}
        .filters input[type="date"], .filters select { padding: 8px; margin-right: 15px; border: 1px solid #ccc; border-radius: 3px; }
        .filters button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .filters button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .action-btn { padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; text-decoration: none; }
        .action-btn:hover { background-color: #218838; }
        .char-limit { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Visor de Consultas</h1>

        <div class="filters">
            <label for="fecha_desde">Fecha Desde:</label>
            <input type="date" id="fecha_desde" name="fecha_desde">

            <label for="fecha_hasta">Fecha Hasta:</label>
            <input type="date" id="fecha_hasta" name="fecha_hasta">

            <label for="respuesta_vacia">Respuesta Vacía:</label>
            <select id="respuesta_vacia" name="respuesta_vacia">
                <option value="">Todos</option>
                <option value="1">Sí</option>
                <option value="0">No</option>
            </select>

            <label for="respuesta_util">Respuesta Útil:</label>
            <select id="respuesta_util" name="respuesta_util">
                <option value="">Todos</option>
                <option value="1">Sí</option>
                <option value="0">No</option>
            </select>

            <button onclick="aplicarFiltros()">Filtrar</button>
        </div>

        <table id="tablaConsultas">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>ID Usuario</th>
                    <th>UGEL Origen</th>
                    <th>Pregunta (resumen)</th>
                    <th>Respuesta (resumen)</th>
                    <th>Respuesta Vacía</th>
                    <th>Respuesta Útil</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se cargarán aquí -->
            </tbody>
        </table>
    </div>

    <script>
        async function aplicarFiltros() {
            const fechaDesde = document.getElementById('fecha_desde').value;
            const fechaHasta = document.getElementById('fecha_hasta').value;
            const respuestaVacia = document.getElementById('respuesta_vacia').value;
            const respuestaUtil = document.getElementById('respuesta_util').value;

            let queryParams = new URLSearchParams();
            if (fechaDesde) queryParams.append('fecha_desde', fechaDesde);
            if (fechaHasta) queryParams.append('fecha_hasta', fechaHasta);
            if (respuestaVacia !== "") queryParams.append('respuesta_es_vacia', respuestaVacia);
            if (respuestaUtil !== "") queryParams.append('respuesta_util', respuestaUtil);

            const response = await fetch(`/api/consultas_filtradas?${queryParams.toString()}`);
            const data = await response.json();

            const tablaBody = document.getElementById('tablaConsultas').getElementsByTagName('tbody')[0];
            tablaBody.innerHTML = ''; // Limpiar tabla anterior

            if (data.error) {
                alert("Error al cargar datos: " + data.error);
                return;
            }
            
            if (data.length === 0) {
                const row = tablaBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 8;
                cell.textContent = "No se encontraron registros con los filtros aplicados.";
                cell.style.textAlign = "center";
            } else {
                data.forEach(consulta => {
                    const row = tablaBody.insertRow();
                    row.insertCell().textContent = new Date(consulta.timestamp).toLocaleString();
                    row.insertCell().textContent = consulta.id_usuario;
                    row.insertCell().textContent = consulta.ugel_origen;
                    
                    const preguntaCell = row.insertCell();
                    preguntaCell.textContent = consulta.pregunta_usuario_truncada;
                    preguntaCell.title = consulta.pregunta_usuario_completa; // Tooltip con texto completo
                    preguntaCell.classList.add('char-limit');


                    const respuestaCell = row.insertCell();
                    respuestaCell.textContent = consulta.respuesta_asistente_truncada;
                    respuestaCell.title = consulta.respuesta_asistente_completa; // Tooltip con texto completo
                    respuestaCell.classList.add('char-limit');

                    row.insertCell().textContent = consulta.respuesta_es_vacia ? 'Sí' : 'No';
                    row.insertCell().textContent = consulta.respuesta_util ? 'Sí' : 'No';
                    
                    const actionCell = row.insertCell();
                    const verButton = document.createElement('button');
                    verButton.textContent = 'Ver';
                    verButton.classList.add('action-btn');
                    verButton.onclick = function() { verDetalle(consulta.id_consulta); };
                    actionCell.appendChild(verButton);
                });
            }
        }

        function verDetalle(idConsulta) {
            // Aquí puedes implementar la lógica para mostrar más detalles de la consulta.
            // Por ejemplo, abrir un modal, redirigir a otra página, etc.
            alert('Acción "Ver" para la consulta ID: ' + idConsulta + '. Aún por implementar.');
            console.log('ID de consulta para ver detalle:', idConsulta);
        }

        // Cargar datos al iniciar la página (opcional, sin filtros)
        // window.onload = aplicarFiltros; 
    </script>
</body>
</html>